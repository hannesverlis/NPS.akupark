<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akupargi Kauplemise Simulaator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.active {
            display: block;
        }

        .results {
            margin-top: 30px;
        }

        .summary {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }

        thead {
            background: #667eea;
            color: white;
        }

        th {
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
        }

        tbody tr {
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        td {
            padding: 6px;
            color: #333;
            line-height: 1.4;
        }

        .positive {
            color: #28a745;
            font-weight: 600;
            font-size: 11px;
        }

        .negative {
            color: #dc3545;
            font-weight: 600;
            font-size: 11px;
        }

        .neutral {
            color: #666;
            font-size: 11px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .nps-hind {
            font-size: 11px;
            color: #666;
            font-style: italic;
        }

        .erinevus-cell {
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîã Akupargi Kauplemise Simulaator</h1>
        <p class="subtitle">Nord Pool Spot (NPS) elektrienergia tunnihindade anal√º√ºs</p>

        <div class="form-container">
            <div class="form-row">
                <div class="form-group">
                    <label for="aku_voimsus">Aku V√µimsus (MW)</label>
                    <input type="number" id="aku_voimsus" value="50" step="0.1" min="1">
                </div>
                <div class="form-group">
                    <label for="aku_mahtuvus">Aku Mahtuvus (MWh)</label>
                    <input type="number" id="aku_mahtuvus" value="100" step="1" min="1">
                </div>
                <div class="form-group">
                    <label for="efektiivsus">Efektiivsus (%)</label>
                    <input type="number" id="efektiivsus" value="87" step="0.1" min="1" max="100">
                </div>
                <div class="form-group">
                    <label for="max_aeg">Maks. Aeg Vahel (h)</label>
                    <input type="number" id="max_aeg" value="8" step="1" min="1" max="24">
                </div>
            </div>
            <button id="arvutaBtn" onclick="arvuta()">Arvuta</button>
        </div>

        <div class="loading" id="loading">
            <p>Laen andmeid ja arvutan tulemusi... Palun oodake.</p>
        </div>

        <div class="error" id="error"></div>

        <div class="results" id="results" style="display: none;">
            <div class="summary" id="summary"></div>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Kuu</th>
                        <th>Ts√ºklite Arv</th>
                        <th>Kogutulu (EUR)</th>
                        <th>Keskmine Tulu (EUR)</th>
                        <th>Erinevus Keskmisest</th>
                        <th>Keskmine NPS Hind (EUR/MWh)</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const CSV_FILES = [
            'Tuulikutasu 2024 I KV.csv',
            'Tuulikutasu 2024 II KV_0.csv',
            'Tuulikutasu 2024 III KV.csv',
            'Tuulikutasu 2024 IV KV.csv',
            'Tuulikutasu 2025 I.csv',
            'Tuulikutasu 2025_II_kvartal.csv',
            'Tuulikutasu 2025_III_kvartal.csv'
        ];

        const GITHUB_RAW_URL = 'https://raw.githubusercontent.com/hannesverlis/NPS.akupark/main/';

        async function parseCSV(text) {
            const lines = text.split('\n');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = line.split(';');
                if (parts.length < 3) continue;
                
                try {
                    const timestamp = parseInt(parts[0]);
                    const dateStr = parts[1];
                    const priceStr = parts[2].replace(',', '.');
                    const price = parseFloat(priceStr);
                    
                    if (isNaN(price) || !dateStr) continue;
                    
                    // Parse date: "01.01.2024 00:00"
                    const [datePart, timePart] = dateStr.split(' ');
                    const [day, month, year] = datePart.split('.');
                    const [hour, minute] = timePart.split(':');
                    
                    const date = new Date(year, month - 1, day, hour, minute);
                    
                    data.push({
                        date: date,
                        price: price
                    });
                } catch (e) {
                    console.warn('Error parsing line:', line, e);
                }
            }
            
            return data;
        }

        async function loadCSVFiles() {
            const allData = [];
            
            for (const filename of CSV_FILES) {
                try {
                    const url = GITHUB_RAW_URL + encodeURIComponent(filename);
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.warn(`Failed to load ${filename}`);
                        continue;
                    }
                    const text = await response.text();
                    const data = await parseCSV(text);
                    allData.push(...data);
                } catch (e) {
                    console.error(`Error loading ${filename}:`, e);
                }
            }
            
            // Sort by date
            allData.sort((a, b) => a.date - b.date);
            return allData;
        }

        function optimeeriTsukkel(hinnadPaev, akuMahtuvusMWh, akuVoimsusMW, efektiivsus, maxAegVahel) {
            if (hinnadPaev.length < 2) {
                return { laadimine: null, tuhjendamine: null, tulu: 0 };
            }
            
            const tagastatavEnergia = akuMahtuvusMWh * efektiivsus;
            const laadimiseTunnid = Math.ceil(akuMahtuvusMWh / akuVoimsusMW);
            const tuhjendamiseTunnid = Math.ceil(tagastatavEnergia / akuVoimsusMW);
            
            let maxTulu = -Infinity;
            let parimLaadimine = null;
            let parimTuhjendamine = null;
            
            // Optimeerime laadimise
            for (let laadimiseAlgus = 0; laadimiseAlgus <= hinnadPaev.length - laadimiseTunnid; laadimiseAlgus++) {
                // Variant 1: J√§rjestikused tunnid
                const laadimiseJ√§rjestikused = [];
                for (let i = 0; i < laadimiseTunnid; i++) {
                    laadimiseJ√§rjestikused.push(laadimiseAlgus + i);
                }
                
                let laadimiseKuluJ√§rjestikused = 0;
                for (const idx of laadimiseJ√§rjestikused) {
                    laadimiseKuluJ√§rjestikused += hinnadPaev[idx].price * akuVoimsusMW;
                }
                
                // Variant 2: Mitte-j√§rjestikused tunnid (odavaimad)
                const koguPaevHinnad = hinnadPaev.map((h, i) => ({ idx: i, price: h.price }));
                koguPaevHinnad.sort((a, b) => a.price - b.price);
                const odavaimadTunnid = koguPaevHinnad.slice(0, laadimiseTunnid).map(x => x.idx);
                
                let laadimiseKuluMitteJ√§rjestikused = 0;
                for (const idx of odavaimadTunnid) {
                    laadimiseKuluMitteJ√§rjestikused += hinnadPaev[idx].price * akuVoimsusMW;
                }
                
                // Valime parema variandi
                let laadimiseIndeksid, laadimiseKulu;
                if (laadimiseKuluMitteJ√§rjestikused < laadimiseKuluJ√§rjestikused) {
                    laadimiseIndeksid = odavaimadTunnid;
                    laadimiseKulu = laadimiseKuluMitteJ√§rjestikused;
                } else {
                    laadimiseIndeksid = laadimiseJ√§rjestikused;
                    laadimiseKulu = laadimiseKuluJ√§rjestikused;
                }
                
                const laadimiseLopp = Math.max(...laadimiseIndeksid);
                const tuhjendamiseAlgusV√µimalik = laadimiseLopp + 1;
                const tuhjendamiseLoppV√µimalik = Math.min(laadimiseLopp + maxAegVahel + 1, hinnadPaev.length);
                
                if (tuhjendamiseAlgusV√µimalik >= hinnadPaev.length) continue;
                
                // Optimeerime t√ºhjendamise
                for (let tuhjendamiseAlgus = tuhjendamiseAlgusV√µimalik; tuhjendamiseAlgus <= tuhjendamiseLoppV√µimalik - tuhjendamiseTunnid; tuhjendamiseAlgus++) {
                    // Variant 1: J√§rjestikused tunnid
                    const tuhjendamiseJ√§rjestikused = [];
                    for (let i = 0; i < tuhjendamiseTunnid; i++) {
                        tuhjendamiseJ√§rjestikused.push(tuhjendamiseAlgus + i);
                    }
                    
                    const laaditudEnergia = laadimiseTunnid * akuVoimsusMW;
                    const tagastatavEnergiaArvutus = laaditudEnergia * efektiivsus;
                    
                    let keskmineHindJ√§rjestikused = 0;
                    for (const idx of tuhjendamiseJ√§rjestikused) {
                        keskmineHindJ√§rjestikused += hinnadPaev[idx].price;
                    }
                    keskmineHindJ√§rjestikused /= tuhjendamiseTunnid;
                    const tuhjendamiseTuluJ√§rjestikused = tagastatavEnergiaArvutus * keskmineHindJ√§rjestikused;
                    
                    // Variant 2: Mitte-j√§rjestikused tunnid (kallimad)
                    const v√µimalikudTunnid = [];
                    for (let i = tuhjendamiseAlgusV√µimalik; i < tuhjendamiseLoppV√µimalik; i++) {
                        v√µimalikudTunnid.push({ idx: i, price: hinnadPaev[i].price });
                    }
                    v√µimalikudTunnid.sort((a, b) => b.price - a.price);
                    const kallimadTunnid = v√µimalikudTunnid.slice(0, tuhjendamiseTunnid).map(x => x.idx);
                    
                    let keskmineHindMitteJ√§rjestikused = 0;
                    for (const idx of kallimadTunnid) {
                        keskmineHindMitteJ√§rjestikused += hinnadPaev[idx].price;
                    }
                    keskmineHindMitteJ√§rjestikused /= tuhjendamiseTunnid;
                    const tuhjendamiseTuluMitteJ√§rjestikused = tagastatavEnergiaArvutus * keskmineHindMitteJ√§rjestikused;
                    
                    // Valime parema variandi
                    let tuhjendamiseIndeksid, tuhjendamiseTulu;
                    if (tuhjendamiseTuluMitteJ√§rjestikused > tuhjendamiseTuluJ√§rjestikused) {
                        tuhjendamiseIndeksid = kallimadTunnid;
                        tuhjendamiseTulu = tuhjendamiseTuluMitteJ√§rjestikused;
                    } else {
                        tuhjendamiseIndeksid = tuhjendamiseJ√§rjestikused;
                        tuhjendamiseTulu = tuhjendamiseTuluJ√§rjestikused;
                    }
                    
                    const tulu = tuhjendamiseTulu - laadimiseKulu;
                    
                    if (tulu > maxTulu) {
                        maxTulu = tulu;
                        parimLaadimine = laadimiseIndeksid;
                        parimTuhjendamine = tuhjendamiseIndeksid;
                    }
                }
            }
            
            if (maxTulu === -Infinity) {
                return { laadimine: null, tuhjendamine: null, tulu: 0 };
            }
            
            return { laadimine: parimLaadimine, tuhjendamine: parimTuhjendamine, tulu: maxTulu };
        }

        async function arvuta() {
            const akuVoimsus = parseFloat(document.getElementById('aku_voimsus').value);
            const akuMahtuvus = parseFloat(document.getElementById('aku_mahtuvus').value);
            const efektiivsus = parseFloat(document.getElementById('efektiivsus').value) / 100;
            const maxAeg = parseInt(document.getElementById('max_aeg').value);

            if (!akuVoimsus || !akuMahtuvus || !efektiivsus || !maxAeg) {
                showError('Palun t√§itke k√µik v√§ljad korrektselt.');
                return;
            }

            const btn = document.getElementById('arvutaBtn');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const results = document.getElementById('results');

            btn.disabled = true;
            loading.classList.add('active');
            error.classList.remove('active');
            results.style.display = 'none';

            try {
                // Laeme CSV failid
                const allData = await loadCSVFiles();
                
                if (allData.length === 0) {
                    throw new Error('Andmeid ei leitud');
                }

                // R√ºhmitame p√§evade kaupa
                const p√§evad = {};
                for (const item of allData) {
                    const p√§evKey = item.date.toISOString().split('T')[0];
                    if (!p√§evad[p√§evKey]) {
                        p√§evad[p√§evKey] = [];
                    }
                    p√§evad[p√§evKey].push(item);
                }

                // Optimeerime iga p√§eva kohta
                const tulemused = [];
                const kuuTulud = {};
                const kuuHinnad = {};

                for (const [p√§evKey, p√§evaAndmed] of Object.entries(p√§evad)) {
                    p√§evaAndmed.sort((a, b) => a.date - b.date);
                    
                    const tulemus = optimeeriTsukkel(p√§evaAndmed, akuMahtuvus, akuVoimsus, efektiivsus, maxAeg);
                    
                    if (tulemus.laadimine !== null && tulemus.tuhjendamine !== null) {
                        const kuu = p√§evaAndmed[0].date.toISOString().substring(0, 7);
                        
                        tulemused.push({
                            p√§ev: p√§evKey,
                            kuu: kuu,
                            tulu: tulemus.tulu
                        });
                        
                        if (!kuuTulud[kuu]) {
                            kuuTulud[kuu] = [];
                        }
                        kuuTulud[kuu].push(tulemus.tulu);
                        
                        // Arvutame kuu keskmise NPS hinna
                        if (!kuuHinnad[kuu]) {
                            const kuuAndmed = allData.filter(d => d.date.toISOString().substring(0, 7) === kuu);
                            const keskmineHind = kuuAndmed.reduce((sum, d) => sum + d.price, 0) / kuuAndmed.length;
                            kuuHinnad[kuu] = keskmineHind;
                        }
                    }
                }

                // Arvutame kuude statistika
                const kuuStatistika = [];
                let koguTulu = 0;
                let koguTsukliteArv = 0;

                for (const kuu of Object.keys(kuuTulud).sort()) {
                    const kuuTulu = kuuTulud[kuu].reduce((a, b) => a + b, 0);
                    const tsukliteArv = kuuTulud[kuu].length;
                    const keskmineTulu = kuuTulu / tsukliteArv;
                    const keskmineNpsHind = kuuHinnad[kuu] || 0;

                    koguTulu += kuuTulu;
                    koguTsukliteArv += tsukliteArv;

                    kuuStatistika.push({
                        kuu: kuu,
                        tsukliteArv: tsukliteArv,
                        kogutulu: kuuTulu,
                        keskmineTulu: keskmineTulu,
                        keskmineNpsHind: keskmineNpsHind
                    });
                }

                const uldineKeskmine = koguTulu / koguTsukliteArv;

                // Lisame erinevuse keskmisest
                for (const stat of kuuStatistika) {
                    stat.erinevusKeskmisest = stat.keskmineTulu - uldineKeskmine;
                }

                displayResults({
                    kuuStatistika: kuuStatistika,
                    kokkuTsukleid: koguTsukliteArv,
                    kogutulu: koguTulu,
                    keskmineTulu: uldineKeskmine
                });

                results.style.display = 'block';

            } catch (err) {
                showError('Viga: ' + err.message);
            } finally {
                btn.disabled = false;
                loading.classList.remove('active');
            }
        }

        function displayResults(data) {
            const summary = document.getElementById('summary');
            const tbody = document.getElementById('resultsBody');

            summary.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">Kokku Ts√ºkleid</div>
                    <div class="summary-value">${data.kokkuTsukleid}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Kogutulu</div>
                    <div class="summary-value">${formatCurrency(data.kogutulu)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Keskmine Tulu</div>
                    <div class="summary-value">${formatCurrency(data.keskmineTulu)}</div>
                </div>
            `;

            tbody.innerHTML = '';
            data.kuuStatistika.forEach(stat => {
                const row = document.createElement('tr');
                const erinevus = stat.erinevusKeskmisest;
                const erinevusClass = erinevus > 0 ? 'positive' : erinevus < 0 ? 'negative' : 'neutral';
                const erinevusSign = erinevus > 0 ? '+' : '';

                row.innerHTML = `
                    <td><strong>${formatKuu(stat.kuu)}</strong></td>
                    <td>${stat.tsukliteArv}</td>
                    <td><strong>${formatCurrency(stat.kogutulu)}</strong></td>
                    <td>${formatCurrency(stat.keskmineTulu)}</td>
                    <td class="${erinevusClass} erinevus-cell">${erinevusSign}${formatCurrency(erinevus)}</td>
                    <td><span class="nps-hind">${formatCurrency(stat.keskmineNpsHind)}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('et-EE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatKuu(kuuString) {
            const [aasta, kuu] = kuuString.split('-');
            const kuud = [
                'Jaanuar', 'Veebruar', 'M√§rts', 'Aprill', 'Mai', 'Juuni',
                'Juuli', 'August', 'September', 'Oktoober', 'November', 'Detsember'
            ];
            return `${kuud[parseInt(kuu) - 1]} ${aasta}`;
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.classList.add('active');
        }
    </script>
</body>
</html>

